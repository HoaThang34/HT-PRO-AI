<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>HT Pro AI Workspace</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;600&display=swap');
        
        :root {
            --bg-dark: #0b0b15;
            --sidebar-bg: rgba(20, 20, 35, 0.95);
            --accent: #00f260;
            --accent-glow: rgba(0, 242, 96, 0.5);
            --accent-2: #0575e6;
            --text: #ffffff;
            --panel: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --code-bg: #151515;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text); 
            height: 100dvh;
            display: flex; overflow: hidden;
            position: relative;
        }

        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        .sidebar { 
            width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; padding: 20px; z-index: 100; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }
        .mobile-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 90; display: none; 
            backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s; 
        }
        .mobile-overlay.show { opacity: 1; }

        .brand { 
            font-family: 'Orbitron', sans-serif; font-size: 1.5rem; 
            background: linear-gradient(to right, var(--accent), var(--accent-2)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 20px; font-weight: bold; letter-spacing: 1px;
        }
        
        .user-card { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; 
            margin-bottom: 20px; cursor: pointer; transition: 0.2s; 
        }
        .avatar { 
            width: 35px; height: 35px; border-radius: 50%; 
            background: linear-gradient(135deg, var(--accent), var(--accent-2)); 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; color: #000; flex-shrink: 0; 
        }
        
        .btn-new { 
            background: linear-gradient(90deg, var(--accent-2), var(--accent)); 
            border: none; color: white; padding: 12px; border-radius: 10px; 
            cursor: pointer; font-weight: bold; display: flex; align-items: center; 
            gap: 10px; justify-content: center; margin-bottom: 20px; width: 100%; 
            box-shadow: 0 4px 15px rgba(5, 117, 230, 0.3);
        }
        
        .history-list { flex: 1; overflow-y: auto; }
        .h-item { 
            padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; 
            color: #aaa; font-size: 0.9rem; white-space: nowrap; overflow: hidden; 
            text-overflow: ellipsis; transition: 0.2s;
        }
        .h-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .h-item.active { background: rgba(0, 242, 96, 0.1); color: var(--accent); border-left: 3px solid var(--accent); }

        .main { 
            flex: 1; display: flex; flex-direction: column; 
            position: relative; width: 100%; height: 100%; z-index: 1; 
            overflow: hidden;
        }
        
        .header-bar { 
            padding: 0 20px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(11, 11, 21, 0.8); backdrop-filter: blur(10px); 
            height: 60px; flex-shrink: 0; z-index: 20;
        }
        .mobile-menu-btn { display: none; background: none; border: none; color: white; font-size: 1.4rem; padding: 5px; }

        .model-switch { background: rgba(0,0,0,0.5); border-radius: 20px; padding: 3px; display: flex; border: 1px solid var(--border); }
        .model-opt { padding: 5px 12px; cursor: pointer; border-radius: 15px; font-size: 0.75rem; color: #888; font-weight: 600; white-space: nowrap; transition: 0.3s; }
        .model-opt.active { color: #000; background: var(--accent); }
        
        .icon-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #ccc; 
            width: 35px; height: 35px; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; transition: 0.2s; 
        }

        .chat-area { 
            flex: 1; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; gap: 20px; 
            scroll-behavior: smooth; 
        }
        
        .msg { display: flex; gap: 10px; max-width: 850px; width: 100%; margin: 0 auto; opacity: 0; animation: fadeIn 0.3s forwards; }
        .msg.user { flex-direction: row-reverse; }
        .msg .content { 
            padding: 12px 16px; line-height: 1.6; max-width: 85%; border-radius: 15px; font-size: 0.95rem; 
            word-wrap: break-word; overflow-wrap: break-word;
        }
        .msg.user .content { background: linear-gradient(135deg, var(--accent-2), #3a8bfd); color: white; border-top-right-radius: 2px; }
        .msg.model .content { background: rgba(255,255,255,0.08); border: 1px solid var(--border); border-top-left-radius: 2px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border); }
        
        .typing-cursor::after { content: '‚ñã'; display: inline-block; vertical-align: middle; color: var(--accent); animation: blink 0.8s infinite; margin-left: 4px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes fadeIn { to { opacity: 1; } }

        .input-zone { 
            padding: 15px; background: rgba(11, 11, 21, 0.95); 
            border-top: 1px solid var(--border); flex-shrink: 0; z-index: 50;
            display: flex; flex-direction: column; gap: 5px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        #file-preview { 
            display: none; padding: 6px 12px; color: var(--accent); font-size: 0.8rem; 
            background: rgba(0, 242, 96, 0.15); border-radius: 6px; width: fit-content;
        }
        .input-wrap { 
            width: 100%; max-width: 850px; margin: 0 auto; background: rgba(255,255,255,0.05); 
            border: 1px solid var(--border); border-radius: 24px; padding: 8px 12px; 
            display: flex; align-items: flex-end; gap: 8px; 
        }
        textarea { 
            flex: 1; background: transparent; border: none; color: white; 
            padding: 10px 0; resize: none; outline: none; font-family: inherit; 
            max-height: 120px; font-size: 1rem; line-height: 1.4;
        }
        .send-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--accent); 
            color: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; 
            transition: 0.2s; font-size: 1.1rem;
        }
        .send-btn.stop { background: #ff4b4b; color: white; animation: pulseRed 2s infinite; }
        
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 75, 75, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0); } }

        .welcome-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center; }
        .welcome-logo { font-size: 3rem; background: linear-gradient(135deg, var(--accent), var(--accent-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px; }
        .suggestion-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; max-width: 600px; }
        .suggestion-card { background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 15px; border-radius: 12px; text-align: left; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .suggestion-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); border-color: var(--accent); }

        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 80%; max-width: 300px; box-shadow: 10px 0 50px rgba(0,0,0,0.8); }
            .sidebar.active { transform: translateX(0); }
            .mobile-menu-btn { display: block; }
            .input-zone { padding: 10px; } 
            .chat-area { padding: 15px; }
            .suggestion-grid { grid-template-columns: 1fr; }
            .welcome-logo { font-size: 2.5rem; }
            .header-bar { padding: 0 15px; height: 55px; }
        }

        #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; align-items: center; }
        .toast { background: rgba(20,20,30,0.95); color: white; padding: 10px 20px; border-radius: 50px; border: 1px solid var(--accent); backdrop-filter: blur(5px); font-size: 0.9rem; display: flex; gap: 10px; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .toast i { color: var(--accent); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s; }
        .modal.show { opacity: 1; }
        .modal-content { background: #1a1a2e; border: 1px solid var(--border); width: 90%; max-width: 500px; border-radius: 15px; overflow: hidden; max-height: 80vh; display: flex; flex-direction: column; transform: scale(0.9); transition: transform 0.3s; }
        .modal.show .modal-content { transform: scale(1); }
        .modal-body { padding: 20px; overflow-y: auto; }
        .form-control { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; border-radius: 8px; outline: none; margin-bottom: 15px; }
        .btn-save { background: var(--accent-2); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
        
        .code-block-wrapper { margin: 10px 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .code-header { display: flex; justify-content: space-between; background: #252525; padding: 5px 10px; font-size: 0.8rem; color: #aaa; }
        .copy-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; }
        pre { margin: 0; padding: 10px; background: var(--code-bg) !important; font-size: 0.9rem; }

        .thinking-box { background: rgba(0, 242, 96, 0.05); border-left: 3px solid var(--accent); margin-bottom: 15px; border-radius: 4px; overflow: hidden; font-size: 0.9rem; }
        .think-header { background: rgba(0, 242, 96, 0.1); padding: 8px 12px; color: var(--accent); font-weight: bold; font-family: 'Orbitron', sans-serif; display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
        .think-header:hover { background: rgba(0, 242, 96, 0.2); }
        .think-content { padding: 10px 15px; color: #aaa; font-style: italic; font-family: 'Consolas', monospace; display: block; white-space: pre-wrap; border-top: 1px solid rgba(0, 242, 96, 0.1); }
        .fa-brain.thinking { animation: pulseBrain 1.5s infinite; }
        @keyframes pulseBrain { 0% { opacity: 0.5; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); color: #fff; } 100% { opacity: 0.5; transform: scale(0.9); } }
    </style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<div id="toast-container"></div>
<div class="mobile-overlay" onclick="toggleSidebar()"></div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div style="padding:15px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05);">
            <h3 style="margin:0; font-size:1.1rem;">C√†i ƒë·∫∑t</h3>
            <button onclick="closeSettings()" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
        </div>
        <div class="modal-body">
            <h4 style="color:var(--accent); margin-top:0;">H·ªì s∆°</h4>
            <input type="text" class="form-control" id="st-fullname" value="{{ user['fullname'] }}" placeholder="T√™n hi·ªÉn th·ªã">
            <input type="email" class="form-control" id="st-email" value="{{ user['email'] }}" placeholder="Email">
            <button class="btn-save" onclick="updateProfile()">L∆∞u thay ƒë·ªïi</button>

            <h4 style="color:var(--accent); margin-top:20px;">AI Persona</h4>
            <textarea class="form-control" id="st-instruction" rows="3" placeholder="V√≠ d·ª•: H√£y ƒë√≥ng vai chuy√™n gia l·∫≠p tr√¨nh...">{{ settings.get('custom_instruction', '') }}</textarea>
            <button class="btn-save" onclick="saveAISettings()" style="background: #333; border:1px solid var(--border);">L∆∞u Persona</button>

            <h4 style="color:var(--accent); margin-top:20px;">B·∫£o m·∫≠t</h4>
            <input type="password" class="form-control" id="st-new-pass" placeholder="M·∫≠t kh·∫©u m·ªõi">
            <button class="btn-save" onclick="changePassword()" style="background: #333; border:1px solid var(--border);">ƒê·ªïi m·∫≠t kh·∫©u</button>
            <button class="btn-save" onclick="window.location.href='/logout'" style="background:transparent; border:1px solid #ff4b4b; color:#ff4b4b; margin-top:15px;">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>
</div>

<div class="sidebar">
    <div class="brand"><i class="fas fa-robot"></i> HT PRO AI</div>
    <div class="user-card" onclick="openSettings(); toggleSidebar()">
        <div class="avatar">{{ user['username'][0].upper() }}</div>
        <div style="flex:1; overflow:hidden;">
            <div style="font-weight:600; font-size:0.9rem; color:white;">{{ user['fullname'] }}</div>
            <div style="font-size:0.7rem; color:var(--accent);">Online</div>
        </div>
        <i class="fas fa-cog" style="color:#666;"></i>
    </div>
    <button class="btn-new" onclick="newChat(); toggleSidebar()"><i class="fas fa-plus"></i> Chat m·ªõi</button>
    <div class="history-list" id="history-list"></div>
</div>

<div class="main">
    <div class="header-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div class="model-switch">
                <div class="model-opt active" id="mod-fast" onclick="setModel('fast')">Fast ‚ö°</div>
                <div class="model-opt" id="mod-super" onclick="setModel('super')">Super üß†</div>
            </div>
        </div>
        <button class="icon-btn" onclick="exportChat()"><i class="fas fa-download"></i></button>
    </div>
    
    <div class="chat-area" id="chat-box"></div>
    
    <div class="input-zone">
        <div id="file-preview">
            <i class="fas fa-image"></i> <span id="file-name">anh.png</span> 
            <i class="fas fa-times" style="cursor:pointer; margin-left:8px;" onclick="clearFile()"></i>
        </div>
        <div class="input-wrap">
            <input type="file" id="file-input" accept="image/*, .pdf, .txt, .csv, .json" style="display:none;" onchange="handleFileSelect()">
            <button class="icon-btn" onclick="document.getElementById('file-input').click()" style="border:none; width:35px; height:35px;" title="G·ª≠i ·∫£nh/File">
                <i class="fas fa-paperclip"></i>
            </button>
            <button class="icon-btn" onclick="startDictation()" style="border:none; width:35px; height:35px;" title="Voice">
                <i class="fas fa-microphone"></i>
            </button>
            <textarea id="inp" rows="1" placeholder="Nh·∫≠p tin nh·∫Øn..."></textarea>
            <button class="send-btn" id="btn-send" onclick="handleSendClick()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    let currentConvId = null; 
    let currentModel = 'fast';
    let abortController = null; 

    const chatBox = document.getElementById('chat-box'); 
    const inp = document.getElementById('inp'); 
    const btnSend = document.getElementById('btn-send');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const fileNameDisplay = document.getElementById('file-name');

    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.vx = (Math.random() - 0.5) * 0.5;
            this.vy = (Math.random() - 0.5) * 0.5;
            this.size = Math.random() * 2;
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
        }
        draw() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
        }
    }

    function initParticles() {
        particles = [];
        for (let i = 0; i < 50; i++) particles.push(new Particle());
    }

    function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particles.length; i++) {
            particles[i].update(); particles[i].draw();
            for (let j = i; j < particles.length; j++) {
                const dx = particles[i].x - particles[j].x;
                const dy = particles[i].y - particles[j].y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 120) {
                    ctx.strokeStyle = `rgba(255, 255, 255, ${0.05 - dist/2400})`;
                    ctx.lineWidth = 0.5; ctx.beginPath();
                    ctx.moveTo(particles[i].x, particles[i].y);
                    ctx.lineTo(particles[j].x, particles[j].y);
                    ctx.stroke();
                }
            }
        }
        requestAnimationFrame(animateParticles);
    }
    initParticles(); animateParticles();

    function showToast(msg, type='info') {
        const t = document.createElement('div'); t.className = 'toast';
        t.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'info-circle'}"></i> ${msg}`;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 3000);
    }

    function toggleSidebar() {
        const sb = document.querySelector('.sidebar');
        const ov = document.querySelector('.mobile-overlay');
        sb.classList.toggle('active');
        if (sb.classList.contains('active')) {
            ov.style.display = 'block'; setTimeout(()=>ov.classList.add('show'), 10);
        } else {
            ov.classList.remove('show'); setTimeout(()=>ov.style.display = 'none', 300);
        }
    }

    function handleFileSelect() {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            let icon = 'fa-file';
            if (file.type.startsWith('image/')) icon = 'fa-image';
            else if (file.type === 'application/pdf') icon = 'fa-file-pdf';
            else if (file.type.includes('text') || file.name.endsWith('.txt')) icon = 'fa-file-alt';
            
            document.getElementById('file-preview').innerHTML = `
                <i class="fas ${icon}"></i> 
                <span id="file-name" style="margin-left:5px; max-width: 150px; overflow:hidden; text-overflow:ellipsis; display:inline-block; vertical-align:bottom;">${file.name}</span> 
                <i class="fas fa-times" style="cursor:pointer; margin-left:8px; color:#ff4b4b" onclick="clearFile()"></i>
            `;
            filePreview.style.display = 'block';
        }
    }
    function clearFile() { fileInput.value = ''; filePreview.style.display = 'none'; }

    function setModel(t) { 
        currentModel = t; 
        document.getElementById('mod-fast').className = t==='fast'?'model-opt active':'model-opt'; 
        document.getElementById('mod-super').className = t==='super'?'model-opt active':'model-opt'; 
        showToast('ƒê√£ chuy·ªÉn sang ' + (t==='fast'?'Fast Mode':'Super Mode')); 
    }

    function showWelcome() {
        const h = new Date().getHours(); const g = h<12?"Ch√†o bu·ªïi s√°ng":(h<18?"Ch√†o bu·ªïi chi·ªÅu":"Ch√†o bu·ªïi t·ªëi");
        const suggestions = [
            { icon: 'üíª', title: 'Code Python', prompt: 'Vi·∫øt code Python t·∫°o server Flask' },
            { icon: 'üìù', title: 'Vi·∫øt Email', prompt: 'Vi·∫øt email xin ngh·ªâ ph√©p l·ªãch s·ª±' },
            { icon: 'üé®', title: '√ù t∆∞·ªüng', prompt: 'G·ª£i √Ω 5 t√™n d·ª± √°n Startup hay' },
            { icon: 'üß†', title: 'Gi·∫£i th√≠ch', prompt: 'Gi·∫£i th√≠ch AI cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu' }
        ];
        const cards = suggestions.map(s => `<div class="suggestion-card" onclick="usePrompt('${s.prompt}')"><div style="color:var(--accent); font-size:1.1rem; margin-bottom:5px;">${s.icon}</div><div style="font-weight:bold; margin-bottom:5px; font-size:0.9rem;">${s.title}</div><div style="font-size:0.8rem; color:#aaa;">${s.prompt}</div></div>`).join('');
        chatBox.innerHTML = `<div class="welcome-container"><div class="welcome-logo"><i class="fas fa-robot"></i></div><div style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;">${g}, {{ user['fullname'] }}!</div><div style="color:#888; margin-bottom:25px; font-size:0.9rem;">HT Pro AI ƒë√£ s·∫µn s√†ng. B·∫°n c·∫ßn gi√∫p g√¨?</div><div class="suggestion-grid">${cards}</div></div>`;
    }

    function usePrompt(t) { inp.value = t; handleSendClick(); }

    function handleSendClick() {
        if (btnSend.classList.contains('stop')) {
            if (abortController) { abortController.abort(); abortController = null; endStreamState(); showToast('ƒê√£ d·ª´ng tr·∫£ l·ªùi'); }
        } else { sendStream(); }
    }

    function startStreamState() { btnSend.innerHTML = '<i class="fas fa-stop"></i>'; btnSend.classList.add('stop'); }
    function endStreamState() { 
        btnSend.innerHTML = '<i class="fas fa-paper-plane"></i>'; btnSend.classList.remove('stop'); 
        document.querySelectorAll('.typing-cursor').forEach(el => el.classList.remove('typing-cursor'));
        document.querySelectorAll('pre code').forEach((block) => { if(!block.parentElement.classList.contains('code-processed')) { hljs.highlightElement(block); addCopyButton(block); block.parentElement.classList.add('code-processed'); }});
    }

    function addCopyButton(block) {
        const pre = block.parentElement;
        const wrapper = document.createElement('div'); wrapper.className = 'code-block-wrapper';
        const header = document.createElement('div'); header.className = 'code-header';
        const lang = block.className.replace('language-', '') || 'Code';
        header.innerHTML = `<span style="text-transform:uppercase; font-weight:bold;">${lang}</span>`;
        const btn = document.createElement('button'); btn.className = 'copy-btn';
        btn.innerHTML = '<i class="far fa-copy"></i> Copy';
        btn.onclick = () => { navigator.clipboard.writeText(block.textContent); btn.innerHTML = '<i class="fas fa-check"></i> Copied'; setTimeout(() => btn.innerHTML = '<i class="far fa-copy"></i> Copy', 2000); };
        header.appendChild(btn);
        pre.parentNode.insertBefore(wrapper, pre); wrapper.appendChild(header); wrapper.appendChild(pre);
    }

    async function sendStream() {
        const txt = inp.value.trim(); const file = fileInput.files[0];
        if(!txt && !file) return;
        if(document.querySelector('.welcome-container')) chatBox.innerHTML = '';
        
        let userContent = txt;
        if (file) userContent += ` <br><small style="color:var(--accent)"><i>[File: ${file.name}]</i></small>`;
        appendMsg('user', userContent);

        inp.value = ''; clearFile(); startStreamState();
        const aiDiv = appendMsg('model', '', true); aiDiv.classList.add('typing-cursor');
        
        const fd = new FormData(); fd.append('message', txt); fd.append('conversation_id', currentConvId||''); fd.append('model', currentModel); if (file) fd.append('image', file);
        abortController = new AbortController();

        try {
            const res = await fetch('/api/chat_stream', { method:'POST', body:fd, signal: abortController.signal });
            const nid = res.headers.get('X-Conversation-ID'); if(nid && !currentConvId) { currentConvId = nid; loadConvs(); }
            const r = res.body.getReader(); const d = new TextDecoder(); let acc = "";
            while(true) { 
                const {done, value} = await r.read(); if(done) break; 
                acc += d.decode(value);
                
                let formattedText = acc
                    .replace('<think>', `<div class="thinking-box"><div class="think-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'"><i class="fas fa-brain thinking"></i> Process of Thought...</div><div class="think-content">`)
                    .replace('</think>', `</div></div>`);
                
                aiDiv.innerHTML = marked.parse(formattedText);
                if((chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < 150) chatBox.scrollTop = chatBox.scrollHeight;
            }
        } catch(e) { if (e.name !== 'AbortError') aiDiv.innerText += "\n[L·ªói k·∫øt n·ªëi]"; }
        finally { endStreamState(); chatBox.scrollTop = chatBox.scrollHeight; inp.focus(); }
    }

    function appendMsg(role, txt, stream=false) {
        const d = document.createElement('div'); d.className = `msg ${role}`;
        d.innerHTML = stream ? `<div class="content"></div>` : `<div class="content">${marked.parse(txt)}</div>`;
        chatBox.appendChild(d); 
        if(!stream) setTimeout(() => { d.querySelectorAll('pre code').forEach((block) => { if(!block.parentElement.classList.contains('code-processed')) { hljs.highlightElement(block); addCopyButton(block); block.parentElement.classList.add('code-processed'); }}); }, 0);
        chatBox.scrollTop = chatBox.scrollHeight;
        if(stream) return d.firstChild;
    }

    async function loadConvs() {
        const res = await fetch('/api/conversations'); const d = await res.json();
        const l = document.getElementById('history-list'); l.innerHTML = '';
        d.forEach(c => {
            const el = document.createElement('div'); el.className = `h-item ${c.id==currentConvId?'active':''}`; el.innerText = c.title||'Cu·ªôc tr√≤ chuy·ªán m·ªõi';
            el.onclick = () => { loadMessages(c.id); if(window.innerWidth<=768) toggleSidebar(); }; l.appendChild(el);
        });
    }

    async function loadMessages(id) {
        currentConvId = id; loadConvs(); chatBox.innerHTML = '';
        const res = await fetch(`/api/messages/${id}`); const d = await res.json();
        if(d.length===0) showWelcome(); else { d.forEach(m => appendMsg(m.role, m.content)); chatBox.scrollTop = chatBox.scrollHeight; }
    }

    function newChat() { currentConvId = null; loadConvs(); showWelcome(); }
    
    function openSettings() { 
        const m = document.getElementById('settingsModal'); m.style.display = 'flex'; 
        setTimeout(()=>m.classList.add('show'), 10); 
    }
    function closeSettings() { 
        const m = document.getElementById('settingsModal'); m.classList.remove('show'); 
        setTimeout(()=>m.style.display = 'none', 300); 
    }
    async function updateProfile() { const n = document.getElementById('st-fullname').value, e = document.getElementById('st-email').value; await fetch('/api/update_profile', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({fullname:n, email:e})}); showToast('ƒê√£ l∆∞u h·ªì s∆°', 'success'); setTimeout(()=>location.reload(), 1000); }
    async function changePassword() { const p = document.getElementById('st-new-pass').value; await fetch('/api/change_password', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({current_password:'', new_password:p})}); showToast('ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng', 'success'); }
    async function saveAISettings() { const i = document.getElementById('st-instruction').value; await fetch('/api/save_ai_settings', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({custom_instruction:i})}); showToast('ƒê√£ l∆∞u Persona', 'success'); closeSettings(); }
    function startDictation() { if(window.webkitSpeechRecognition) { const r = new webkitSpeechRecognition(); r.lang="vi-VN"; r.start(); r.onresult=e=>{inp.value+=e.results[0][0].transcript}; showToast('ƒêang nghe...'); } else showToast('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£'); }
    function exportChat() { if(!chatBox.innerText.trim()) return; const t = Array.from(document.querySelectorAll('.msg')).map(d=>`${d.classList.contains('user')?'YOU':'AI'}: ${d.innerText}`).join('\n---\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([t], {type:'text/plain'})); a.download=`chat_${Date.now()}.txt`; a.click(); }

    inp.addEventListener('keypress', e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); handleSendClick(); }});
    
    inp.addEventListener('paste', (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file') {
                const blob = item.getAsFile();
                if (blob.type.startsWith('image/')) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(blob);
                    fileInput.files = dataTransfer.files;
                    handleFileSelect();
                    inp.style.borderColor = 'var(--accent)';
                    setTimeout(() => inp.style.borderColor = 'var(--border)', 300);
                }
            }
        }
    });

    loadConvs(); newChat();
</script>
</body>
</html>